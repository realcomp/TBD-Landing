# Архитектура системы dtg.sportomatics.com

## Общая структура

- **Сервер**: Ubuntu, `/opt/gtd/`
- **Docker контейнеры**: 2 изолированных контейнера
- **Reverse proxy**: nginx на хосте
- **SSL**: certbot (Let's Encrypt)

## Файловая структура
```
/opt/gtd/
├── gtd-mvp-app/              # GTD-приложение (Next.js 16 App Router)
│   ├── src/app/
│   │   ├── api/              # API routes GTD
│   │   │   ├── cleanup-demo-users/
│   │   │   ├── tasks/
│   │   │   ├── session/
│   │   │   ├── create-demo-session/
│   │   │   └── delegations/
│   │   ├── inbox/            # Внутренние роуты приложения
│   │   ├── calendar/
│   │   ├── projects/
│   │   └── ...
│   ├── public/               # Общие статические файлы
│   │   ├── logo.png          # Общий для лендинга и GTD
│   │   ├── favicon.ico       # Общий для лендинга и GTD
│   │   └── robots.txt        # Общий для лендинга и GTD
│   ├── .env.local            # Переменные окружения
│   └── docker-compose.yml
│
└── landing/                   # Лендинг (Vite + React SPA)
    ├── src/
    ├── public/
    │   ├── landing-assets/   # Специфичные файлы лендинга
    │   │   ├── og-image.png
    │   │   ├── placeholder.svg
    │   │   └── *.png (хешированные изображения)
    │   ├── logo.png          # НЕ используется (раздается из GTD)
    │   ├── favicon.ico       # НЕ используется (раздается из GTD)
    │   └── robots.txt        # НЕ используется (раздается из GTD)
    ├── server.js             # Node.js API сервер (http.createServer)
    ├── .env.local            # Переменные окружения
    ├── Dockerfile            # Multi-stage: Vite build + nginx + node
    ├── docker-compose.yml
    ├── nginx.conf            # nginx внутри контейнера
    └── start.sh              # Startup скрипт
```

## Docker контейнеры

### 1. gtd-mvp-app (Next.js 16)

- **Контейнер**: Next.js 16 с App Router
- **Порт**: `127.0.0.1:3002:3000`
- **Backend**: Supabase
- **Auth**: Google OAuth через Supabase
- **TypeScript**: Strict mode (15 файлов с ошибками типов исправлены)
- **Деплой**: 
```bash
  cd /opt/gtd/gtd-mvp-app
  git pull
  docker-compose up -d --build
```

### 2. gtd-landing (Vite + React SPA)

- **Контейнер**: nginx + Node.js
- **Порт хоста**: `127.0.0.1:3003:80`
- **Внутри контейнера**:
  - nginx слушает порт 80 (раздаёт статику из `/usr/share/nginx/html`)
  - Node.js слушает порт 3001 (запускает `server.js`)
  - nginx внутри проксирует `/api/waitlist` на `http://127.0.0.1:3001`
- **Деплой**:
```bash
  cd /opt/gtd/landing
  git pull
  docker-compose up -d --build
```

## nginx конфигурация хоста

**Файл**: `/etc/nginx/sites-available/dtg.sportomatics.com`
```nginx
server {
    server_name dtg.sportomatics.com;
    proxy_buffer_size 16k;
    proxy_buffers 4 16k;
    proxy_busy_buffers_size 16k;
    client_max_body_size 50M;
    
    # Порядок КРИТИЧЕН - nginx обрабатывает по приоритету
    
    # 1. Корень - лендинг (exact match)
    location = / {
        proxy_pass http://127.0.0.1:3003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
    }
    
    # 2. Статика лендинга (специфичные файлы)
    location /landing-assets/ {
        proxy_pass http://127.0.0.1:3003;
        proxy_set_header Host $host;
    }
    
    # 3. Vite compiled assets (JS, CSS с хешами)
    location /assets/ {
        proxy_pass http://127.0.0.1:3003;
        proxy_set_header Host $host;
    }
    
    # 4. API лендинга (приоритетнее /api/)
    location /api/waitlist {
        proxy_pass http://127.0.0.1:3003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
    }
    
    # 5. Всё остальное - GTD приложение (catch-all)
    location / {
        proxy_pass http://127.0.0.1:3002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/dtg.sportomatics.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dtg.sportomatics.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

server {
    if ($host = dtg.sportomatics.com) {
        return 301 https://$host$request_uri;
    }
    server_name dtg.sportomatics.com;
    listen 80;
    return 404;
}
```

## Роутинг запросов

| URL | Назначение | Порт |
|-----|-----------|------|
| `/` | Лендинг (главная страница) | 3003 |
| `/inbox`, `/calendar`, `/projects`, ... | GTD приложение | 3002 |
| `/assets/*` | Vite compiled assets (JS, CSS) | 3003 |
| `/landing-assets/*` | Статика лендинга (изображения) | 3003 |
| `/api/waitlist` | API формы лендинга | 3003 |
| `/api/tasks/*`, `/api/session`, ... | API GTD приложения | 3002 |
| `/logo.png`, `/favicon.ico`, `/robots.txt` | Общие файлы | 3002 |

## Переменные окружения

Оба файла `.env.local` (GTD и лендинг) содержат:
```bash
RESEND_API_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...
VITE_SUPABASE_URL=...
```

## Технические детали

### Лендинг (landing/)

- **Frontend**: Vite + React + TypeScript
- **Роутинг**: react-router-dom (SPA), но используется только `/` и `404`
- **Backend**: `server.js` - чистый `http.createServer` (не Express)
- **API endpoints**:
  - `POST /api/waitlist` - регистрация в waitlist (email, honeypot, rate limiting)
  - `GET /api/waitlist/confirm?token=...` - подтверждение email
- **Email**: Resend API
- **Database**: Supabase (таблица `waiting_list`)
- **Статика**: раздаётся nginx внутри контейнера из `/usr/share/nginx/html`

### GTD приложение (gtd-mvp-app/)

- **Framework**: Next.js 16 (App Router)
- **Backend**: Supabase
- **Auth**: Google OAuth через Supabase
- **API routes**: 
  - `/api/cleanup-demo-users`
  - `/api/tasks/*` (move-to-deleted, complete, assign-project, remove-from-project, update-status, batch-update)
  - `/api/session`
  - `/api/create-demo-session`
  - `/api/delegations`
- **TypeScript**: Strict mode включен

## Процедуры обслуживания

### Обновление лендинга
```bash
cd /opt/gtd/landing
git pull
docker-compose up -d --build
```

### Обновление GTD приложения
```bash
cd /opt/gtd/gtd-mvp-app
git pull
docker-compose up -d --build
```

### Перезагрузка nginx
```bash
nginx -t && systemctl reload nginx
```

### Проверка логов
```bash
# Лендинг
docker logs gtd-landing

# GTD приложение
docker logs gtd-mvp-app
```

### Проверка работоспособности
```bash
# Главная страница (лендинг)
curl -I https://dtg.sportomatics.com/

# GTD приложение
curl -I https://dtg.sportomatics.com/inbox

# Статика лендинга
curl -I https://dtg.sportomatics.com/assets/index-BI84ICE9.css
curl -I https://dtg.sportomatics.com/landing-assets/og-image.png

# API лендинга
curl -I https://dtg.sportomatics.com/api/waitlist

# Общие файлы
curl -I https://dtg.sportomatics.com/logo.png
curl -I https://dtg.sportomatics.com/favicon.ico
```

## Потенциальные проблемы и ограничения

### 1. Конфликт статических файлов

**Проблема**: Если в GTD приложении появятся файлы `/assets/*` или `/landing-assets/*`, они НЕ будут доступны - nginx отправит запросы в лендинг.

**Решение**: Не использовать эти пути в GTD приложении.

### 2. API namespace конфликт

**Проблема**: Новые API endpoints в GTD не должны начинаться с `/api/waitlist`.

**Решение**: Использовать другие пути для API GTD (как сейчас: `/api/tasks/*`, `/api/session`, etc).

### 3. Обновление общих файлов

**Проблема**: `logo.png`, `favicon.ico`, `robots.txt` - общие для лендинга и GTD. Они раздаются из GTD (порт 3002).

**Решение**: При обновлении этих файлов:
1. Обновить в `/opt/gtd/gtd-mvp-app/public/`
2. Пересобрать GTD контейнер: `cd /opt/gtd/gtd-mvp-app && docker-compose up -d --build`
3. НЕ обновлять в `/opt/gtd/landing/public/` - эти файлы не используются

### 4. nginx location priority

**Проблема**: Порядок `location` блоков в nginx критичен. Неправильный порядок сломает роутинг.

**Решение**: Соблюдать текущий порядок:
1. `location = /` (exact match)
2. `location /landing-assets/` (prefix)
3. `location /assets/` (prefix)
4. `location /api/waitlist` (длинный prefix, приоритетнее `/api/`)
5. `location /` (catch-all, последний)

### 5. Rate limiting

**Проблема**: `server.js` лендинга имеет rate limiting - 20 запросов в час с одного IP на `/api/waitlist`.

**Решение**: Для тестирования можно временно закомментировать проверку в `server.js` (строки 207-218).

## Git репозитории

- GTD приложение: приватный репозиторий (путь не указан)
- Лендинг: `https://github.com/realcomp/TBD-Landing`

## Контакты и доступы

- Домен: `dtg.sportomatics.com`
- SSL: Let's Encrypt (автоматическое обновление через certbot)
- Supabase: shared instance для обоих приложений
- Resend API: для отправки email из лендинга